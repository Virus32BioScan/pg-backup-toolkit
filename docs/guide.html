<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<title>PG Backup Toolkit — ПОЛНАЯ инструкция v1.3.3</title>
<style>
:root{--red:#e53935;--yellow:#f6c445;--green:#2e7d32;--black:#111}
html,body{margin:0;padding:0;background:#fff;color:var(--black);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
main{max-width:1100px;margin:28px auto;padding:0 20px}
h1,h2,h3{margin:18px 0 10px}h1{font-size:28px}h2{font-size:22px}h3{font-size:18px}
code,kbd,pre{font-family:ui-monospace,Menlo,Consolas,monospace}
pre{background:#fff;border:1px dashed #ddd;padding:12px;border-radius:8px;overflow:auto}
ol,ul{padding-left:22px}li{margin:6px 0}
.red{color:var(--red)}.yellow{color:var(--yellow)}.green{color:var(--green)}
small{opacity:.9}
table{border-collapse:collapse;width:100%;font-size:15px}
th,td{border:1px solid #ececec;padding:8px 10px;text-align:left;vertical-align:top}
tr:nth-child(even){background:#fafafa}
hr{border:0;border-top:1px solid #eee;margin:18px 0}
</style>
</head>
<body>
<main>

<h1>PG Backup Toolkit <span class="green">ПОЛНАЯ инструкция</span> <small>(v1.3.3)</small></h1>
<p>Ключевые элементы — <span class="green">зелёным</span>, важно — <span class="yellow">жёлтым</span>, внимание — <span class="red">красным</span>. Без «плашек», только цветной текст.</p>

<h2>0. Быстрый старт <span class="green">pg-backup-setup</span></h2>
<pre>chmod 644 ./pg-backup-toolkit_1.3.3_all.deb
sudo apt install ./pg-backup-toolkit_1.3.3_all.deb
sudo pg-backup-setup
</pre>
<p>Мастер спросит <span class="green">PGHOST/PGPORT/PGUSER</span>, <span class="green">MAIL_TO/MAIL_FROM</span>, <span class="green">COMPRESS</span>, создаст профили (<span class="green">nightly/hourly/weekend</span>) и таймеры.</p>

<h2>1. Состав</h2>
<ol>
  <li><span class="green">pg_backup.sh</span> — бэкап (<code>pg_dump -Fc -j</code>, <span class="green">gzip/zstd</span>, <span class="green">GPG</span>, ретеншн, логи, email, хуки).</li>
  <li><span class="green">pg_restore_select.sh</span> — интерактив/CLI восстановление с выбором копии.</li>
  <li><span class="green">pg-backup-setup</span> — мастер конфигурации и расписаний.</li>
  <li><span class="green">pg-backup-profile</span> — профили: create/list/show/remove.</li>
  <li><span class="green">pg-backup-locate</span> — показать каталоги бэкапов и логов.</li>
  <li><span class="green">pg-backup-test</span> — тестовый запуск и проверка артефакта.</li>
  <li><span class="green">systemd</span>: <code>pg-backup@.service</code> + таймеры.</li>
  <li><span class="green">/etc/pg-backup.conf</span>, <span class="green">/etc/pg-backup.d/*.conf</span>, <span class="green">/etc/pg-backup.hooks/*</span>.</li>
</ol>

<h2>2. Требования</h2>
<ul>
  <li><span class="yellow">pg_dump</span> и <span class="yellow">psql</span> в <code>$PATH</code> (подойдут <span class="green">postgresql-client</span> или <span class="green">Postgres Pro client</span>).</li>
  <li>Для почты — <span class="yellow">mailutils</span>/<span class="yellow">bsd-mailx</span>/<span class="yellow">msmtp</span> (необязательно).</li>
</ul>

<h2>3. Установка, обновление, удаление</h2>
<pre>chmod 644 ./pg-backup-toolkit_1.3.3_all.deb
sudo apt install ./pg-backup-toolkit_1.3.3_all.deb
# удаление (бэкапы и БД не трогаются):
sudo apt purge pg-backup-toolkit
</pre>

<h2>4. Общая конфигурация</h2>
<pre>PGHOST="127.0.0.1"
PGPORT="5432"
PGUSER="postgres"
MAIL_TO="dba@example.com"
MAIL_FROM="backups@example.com"
COMPRESS="zstd"             # none|gzip|zstd
BACKUP_DIR="/backups/postgres"
LOG_DIR="/var/log/pg-backup"
</pre>

<h2>5. Профили</h2>
<pre>PROFILE_NAME="nightly"
INCLUDE_DBS=""                             # пусто=все (кроме EXCLUDE_DBS)
EXCLUDE_DBS="template0 template1 postgres" # игнорируется, если INCLUDE_DBS задан
JOBS="4"
KEEP_DAYS="30"
COMPRESS="zstd"
ENCRYPT_GPG="false"
GPG_RECIPIENT=""
BACKUP_DIR="/backups/postgres/nightly"
LOG_DIR="/var/log/pg-backup"
</pre>

<h3>6. Управление профилями</h3>
<pre>sudo pg-backup-profile create myprofile
pg-backup-profile list
pg-backup-profile show myprofile
sudo pg-backup-profile remove myprofile
</pre>
<p class="yellow">Имя профиля = инстанс таймера. Допустимы: <span class="green">a-z</span>, <span class="green">0-9</span>, <span class="green">-</span>.</p>

<h2>7. Расписания (systemd timers)</h2>
<p>Файл таймера: <span class="green">/etc/systemd/system/pg-backup@&lt;profile&gt;.timer</span>. Можно несколько строк <span class="green">OnCalendar</span> в одном таймере.</p>
<pre># Ежедневно в 00:00, 01:00, 05:00
OnCalendar=*-*-* 00:00:00
OnCalendar=*-*-* 01:00:00
OnCalendar=*-*-* 05:00:00

# <span class="green">1-е и 17-е</span> числа месяца в 02:30
OnCalendar=*-*-01 02:30:00
OnCalendar=*-*-17 02:30:00

# Каждый понедельник в 00:00
OnCalendar=Mon *-*-* 00:00:00
</pre>

<h3>8. Дни недели (таблица)</h3>
<table>
  <thead><tr><th>День</th><th class="green">Коротко</th><th>Полное</th></tr></thead>
  <tbody>
    <tr><td>Понедельник</td><td class="green"><code>Mon</code></td><td><code>Monday</code></td></tr>
    <tr><td>Вторник</td><td class="green"><code>Tue</code></td><td><code>Tuesday</code></td></tr>
    <tr><td>Среда</td><td class="green"><code>Wed</code></td><td><code>Wednesday</code></td></tr>
    <tr><td>Четверг</td><td class="green"><code>Thu</code></td><td><code>Thursday</code></td></tr>
    <tr><td>Пятница</td><td class="green"><code>Fri</code></td><td><code>Friday</code></td></tr>
    <tr><td>Суббота</td><td class="green"><code>Sat</code></td><td><code>Saturday</code></td></tr>
    <tr><td>Воскресенье</td><td class="green"><code>Sun</code></td><td><code>Sunday</code></td></tr>
  </tbody>
</table>

<h3>9. Проверка и включение таймеров</h3>
<pre>sudo systemctl daemon-reload
sudo systemctl enable --now pg-backup@nightly.timer
systemctl list-timers | grep pg-backup@
systemd-analyze calendar "Mon..Fri *-*-* 01:00:00"
systemd-analyze calendar "Sat,Sun *-*-* 04:30:00"
</pre>

<h2>10. Логи и структура</h2>
<ul>
  <li>Каждый запуск — отдельный файл <span class="green">LOG_DIR/&lt;profile&gt;_YYYY-MM-DD_HH-MM-SS.log</span>.</li>
  <li>В начале лога — строка <span class="green">ENV: …</span> (видно <span class="green">PROFILE/BACKUP_DIR/LOG_DIR/JOBS/KEEP_DAYS</span>).</li>
</ul>
<pre>journalctl -u pg-backup@nightly.service -e
ls -lt /var/log/pg-backup | head
</pre>

<h2>11. Где лежат бэкапы</h2>
<pre>pg-backup-locate
ls -lh /backups/postgres/nightly
</pre>

<h2>12. Ручной запуск и тест</h2>
<pre>sudo systemctl start pg-backup@nightly.service
sudo pg-backup-test -p nightly --timeout 30
</pre>

<h2>13. Восстановление</h2>
<pre># интерактивно
pg_restore_select.sh

# без вопросов
pg_restore_select.sh --non-interactive --select-file /backups/postgres/nightly/2025-08-10_02-15-00_billing.dump.zst \\
  --db billing_restored --jobs 6 --force-drop
</pre>

<h2>14. Почтовые отчёты</h2>
<p>Если настроен MTA и заданы <span class="green">MAIL_TO</span>/<span class="green">MAIL_FROM</span>, придёт письмо с темой <span class="green">SUCCESS</span> или <span class="red">FAIL</span> и телом лога.</p>
<pre># пример msmtp (минимальный)
/etc/msmtprc (600):
account default
host smtp.example.com
port 587
auth on
user backups@example.com
passwordeval "cat /etc/pg-backup.secret"
from backups@example.com
tls on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
</pre>

<h2>15. Хуки</h2>
<ul>
  <li><span class="green">/etc/pg-backup.hooks/pre.d/</span> — до старта бэкапа.</li>
  <li><span class="green">/etc/pg-backup.hooks/post-db.d/</span> — после каждой БД, ENV: <span class="green">DB_NAME</span>, <span class="green">ARTIFACT_PATH</span>.</li>
  <li><span class="green">/etc/pg-backup.hooks/post.d/</span> — после завершения профиля.</li>
</ul>
<pre># пример post-db: скопировать артефакт на NFS
#!/usr/bin/env bash
set -e
cp -f "$ARTIFACT_PATH" /mnt/backup-mirror/
</pre>

<h2>16. Безопасность</h2>
<ul>
  <li><span class="red">umask 077</span>, приватные каталоги/файлы.</li>
  <li>Пользователь <span class="green">pgbackup</span>; пароли — в <span class="green">/home/pgbackup/.pgpass</span> (600).</li>
  <li>systemd sandbox: <span class="green">NoNewPrivileges</span>, <span class="green">PrivateTmp</span>, <span class="green">ProtectSystem</span>, <span class="green">ProtectHome</span>.</li>
  <li>Шифрование: <span class="green">ENCRYPT_GPG=true</span> + <span class="green">GPG_RECIPIENT</span>.</li>
</ul>

<h2>17. Диагностика (частые ошибки)</h2>
<ul>
  <li><span class="red">pg_dump: not found</span> — поставь <span class="yellow">postgresql-client</span> или клиент Postgres Pro (подойдёт).</li>
  <li><span class="red">Permission denied</span> — проверь <span class="green">pgbackup:pgbackup</span> и права на <span class="green">BACKUP_DIR/LOG_DIR</span>.</li>
  <li><span class="red">Таймер не срабатывает</span> — проверь <span class="green">OnCalendar</span>, <code>systemctl daemon-reload</code>, статус <span class="green">enabled</span>.</li>
  <li><span class="red">Почта не уходит</span> — проверь <span class="yellow">msmtp/mailutils</span>, отправь тест: <code>echo test | mail -s test you@example.com</code>.</li>
</ul>

<hr />
<p><small>Версия документа: <span class="green">1.3.3</span></small></p>
</main>
</body>
</html>
